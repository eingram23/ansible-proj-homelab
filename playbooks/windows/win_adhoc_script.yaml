- name: Run script on host
  hosts: "{{ hostvar }}"
  gather_facts: false
  become: true
  become_user: SYSTEM
  become_method: runas

  tasks:

    - name: Create script on host
      ansible.windows.win_copy:
        content: "{{ script }}"
        dest: c:\temp\script.ps1

    - name: Run script on host
      ansible.windows.win_shell: c:\temp\script.ps1 {{ param }}
      register: output
      ignore_errors: true

    - name: Script output 
      ansible.builtin.debug:
        var: output.stdout_lines
      when: output is defined
        
    - name: Script error
      ansible.builtin.debug:
        var: output.stderr
      when: output is defined and output.stderr != ""

    - name: Clean up script
      ansible.windows.win_file:
        path: c:\temp\script.ps1
        state: absent
    
    - ansible.builtin.fail:
      when: output is defined and output.stderr != ""