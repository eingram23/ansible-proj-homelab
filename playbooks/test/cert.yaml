- name: Test create cert
  hosts: localhost
  become: false
  gather_facts: false

  tasks:

    - name: Login to vault and use the resulting token
      community.hashi_vault.vault_login:
        url: https://vault.local.lan
        auth_method: userpass
        username: "eingram"
        password: "{{ lookup('hashi_vault', 'secret=secret/ssh/eingram:ssh_password') }}"
        validate_certs: false
      register: login_data

    - name: Generate a certificate with an existing token
      community.hashi_vault.vault_pki_generate_certificate:
        role_name: ycdisp-dot-net
        common_name: test1.ycdisp.net
        ttl: 24h
        url: https://vault.local.lan/
        engine_mount_point: pki_int
        auth_method: token
        token: "{{ login_data.login.auth.client_token }}"
        validate_certs: false
      register: cert_data

    - name: Display generated certificate
      debug:
        msg: "{{ cert_data.data.data.certificate }}"

    - name: Display generated private_key
      debug:
        msg: "{{ cert_data.data.data.private_key }}"
